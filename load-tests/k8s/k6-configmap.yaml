apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-scripts
  namespace: inventory-system
  labels:
    app: k6-load-tests
# NOTE: These scripts are separate from the local scripts/ directory by design.
# - Local scripts (scripts/*.js) are optimized for port-forward testing with low rate limits
# - ConfigMap scripts are optimized for in-cluster testing with higher throughput
# - Different configurations are needed due to port-forward limitations
# If you need to update test logic, update both versions accordingly.
data:
  # Smoke test - minimal load for quick verification
  smoke-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    // IN-CLUSTER SMOKE TEST
    // Uses internal Kubernetes service DNS names for direct communication
    // No port-forward limitations - can run higher loads if needed

    export const options = {
      scenarios: {
        smoke_test: {
          executor: 'constant-arrival-rate',
          rate: 10,             // 10 requests per second
          timeUnit: '1s',
          duration: '1m',
          preAllocatedVUs: 5,
          maxVUs: 10,
        },
      },
      thresholds: {
        http_req_failed: ['rate<0.05'],
        http_req_duration: ['p(95)<500'],
      },
    };

    const BASE_URL = __ENV.BASE_URL || 'http://products-service:8001';

    export default function () {
      const res = http.get(`${BASE_URL}/products`);
      
      check(res, {
        'status is 200': (r) => r.status === 200,
        'response has body': (r) => r.body && r.body.length > 0,
      });
      
      sleep(0.05);
    }

  # Products service test
  products-service-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    // IN-CLUSTER PRODUCTS SERVICE TEST
    // Uses internal service URL for direct communication

    const errorRate = new Rate('errors');

    export const options = {
      scenarios: {
        products_test: {
          executor: 'ramping-arrival-rate',
          startRate: 10,
          timeUnit: '1s',
          preAllocatedVUs: 10,
          maxVUs: 50,
          stages: [
            { duration: '30s', target: 20 },
            { duration: '1m', target: 50 },
            { duration: '1m', target: 50 },
            { duration: '30s', target: 20 },
            { duration: '30s', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<500'],
        errors: ['rate<0.1'],
      },
    };

    const BASE_URL = __ENV.BASE_URL || 'http://products-service:8001';

    export default function () {
      let res = http.get(`${BASE_URL}/products`);
      
      const getAllSuccess = check(res, {
        'GET /products status is 200': (r) => r.status === 200,
      });
      errorRate.add(!getAllSuccess);

      if (res.status === 200 && res.body) {
        try {
          const products = JSON.parse(res.body);
          if (products && products.length > 0) {
            const productId = products[0].id;
            res = http.get(`${BASE_URL}/products/${productId}`);
            check(res, {
              'GET /products/{id} status is 200': (r) => r.status === 200,
            });
          }
        } catch (e) {
          errorRate.add(true);
        }
      }

      // Create product
      const payload = JSON.stringify({
        name: `Test Product ${Date.now()}`,
        description: 'Load test product',
        price: 99.99,
        category: 'Test Category',
      });
      const params = { headers: { 'Content-Type': 'application/json' } };
      res = http.post(`${BASE_URL}/products`, payload, params);
      check(res, {
        'POST /products status is 201 or 200': (r) => r.status === 201 || r.status === 200,
      });

      sleep(0.05);
    }

  # Inventory service test
  inventory-service-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    // IN-CLUSTER INVENTORY SERVICE TEST

    const errorRate = new Rate('errors');

    export const options = {
      scenarios: {
        inventory_test: {
          executor: 'ramping-arrival-rate',
          startRate: 10,
          timeUnit: '1s',
          preAllocatedVUs: 10,
          maxVUs: 40,
          stages: [
            { duration: '30s', target: 20 },
            { duration: '1m', target: 40 },
            { duration: '1m', target: 40 },
            { duration: '30s', target: 20 },
            { duration: '30s', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<500'],
        errors: ['rate<0.1'],
      },
    };

    const BASE_URL = __ENV.BASE_URL || 'http://inventory-service:8002';

    export default function () {
      let res = http.get(`${BASE_URL}/inventory`);
      const success = check(res, {
        'inventory list status is 200': (r) => r.status === 200,
      });
      errorRate.add(!success);

      res = http.get(`${BASE_URL}/inventory/1`);
      check(res, {
        'inventory detail status is 200': (r) => r.status === 200,
      });

      const payload = JSON.stringify({ quantity: 2 });
      const params = { headers: { 'Content-Type': 'application/json' } };

      res = http.post(`${BASE_URL}/inventory/1/reserve`, payload, params);
      check(res, {
        'reserve inventory successful': (r) => r.status === 200,
      });

      res = http.post(`${BASE_URL}/inventory/1/fulfill`, payload, params);
      check(res, {
        'fulfill inventory successful': (r) => r.status === 200,
      });

      sleep(0.05);
    }

  # Orders service test
  orders-service-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';
    import { Rate } from 'k6/metrics';

    // IN-CLUSTER ORDERS SERVICE TEST
    // Lower rate than other services due to gRPC calls to Products and Inventory

    const errorRate = new Rate('errors');

    export const options = {
      scenarios: {
        orders_test: {
          executor: 'ramping-arrival-rate',
          startRate: 5,
          timeUnit: '1s',
          preAllocatedVUs: 10,
          maxVUs: 30,
          stages: [
            { duration: '30s', target: 10 },
            { duration: '1m', target: 20 },
            { duration: '1m', target: 20 },
            { duration: '30s', target: 10 },
            { duration: '30s', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<1000'],
        errors: ['rate<0.1'],
      },
    };

    const BASE_URL = __ENV.BASE_URL || 'http://orders-service:8003';

    export default function () {
      let res = http.get(`${BASE_URL}/orders`);
      const success = check(res, {
        'orders list status is 200': (r) => r.status === 200,
      });
      errorRate.add(!success);

      const orderPayload = JSON.stringify({
        customer_id: Math.floor(Math.random() * 1000) + 1,
        items: [
          { product_id: 1, quantity: 1 },
          { product_id: 2, quantity: 2 },
        ],
      });
      const params = { headers: { 'Content-Type': 'application/json' } };

      res = http.post(`${BASE_URL}/orders`, orderPayload, params);
      const orderCreated = check(res, {
        'create order status is 200 or 201': (r) => r.status === 200 || r.status === 201,
      });

      if (orderCreated) {
        try {
          const body = JSON.parse(res.body);
          const orderId = body.id || body.order_id;
          res = http.post(`${BASE_URL}/orders/${orderId}/fulfill`, null, params);
          check(res, {
            'fulfill order successful': (r) => r.status === 200,
          });
        } catch (e) {
          // Order fulfillment failed
        }
      }

      sleep(0.1);
    }

  # Full scenario test - complete user journey
  full-scenario-test.js: |
    import http from 'k6/http';
    import { check, group, sleep } from 'k6';
    import { Rate, Trend } from 'k6/metrics';

    // IN-CLUSTER FULL SCENARIO TEST
    // Complete user journey: Browse → Check Inventory → Order → Fulfill

    const errorRate = new Rate('errors');
    const orderCreationTime = new Trend('order_creation_duration');

    export const options = {
      scenarios: {
        full_journey: {
          executor: 'ramping-arrival-rate',
          startRate: 5,
          timeUnit: '1s',
          preAllocatedVUs: 15,
          maxVUs: 50,
          stages: [
            { duration: '1m', target: 10 },
            { duration: '2m', target: 20 },
            { duration: '2m', target: 30 },
            { duration: '1m', target: 20 },
            { duration: '1m', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<2000'],
        errors: ['rate<0.15'],
        order_creation_duration: ['p(95)<3000'],
      },
    };

    const PRODUCTS_URL = __ENV.PRODUCTS_URL || 'http://products-service:8001';
    const INVENTORY_URL = __ENV.INVENTORY_URL || 'http://inventory-service:8002';
    const ORDERS_URL = __ENV.ORDERS_URL || 'http://orders-service:8003';

    export default function () {
      group('Browse Products', function () {
        const res = http.get(`${PRODUCTS_URL}/products`);
        check(res, { 'products loaded': (r) => r.status === 200 });
      });

      group('Check Inventory', function () {
        const res = http.get(`${INVENTORY_URL}/inventory/1`);
        check(res, { 'inventory checked': (r) => r.status === 200 });
      });

      group('Create and Fulfill Order', function () {
        const orderPayload = JSON.stringify({
          customer_id: Math.floor(Math.random() * 1000) + 1,
          items: [
            { product_id: 1, quantity: 1 },
            { product_id: 3, quantity: 1 },
          ],
        });
        const params = { headers: { 'Content-Type': 'application/json' } };

        const start = new Date();
        const res = http.post(`${ORDERS_URL}/orders`, orderPayload, params);
        const duration = new Date() - start;
        orderCreationTime.add(duration);

        const orderCreated = check(res, {
          'order created': (r) => r.status === 200 || r.status === 201,
        });
        errorRate.add(!orderCreated);

        if (orderCreated) {
          try {
            const body = JSON.parse(res.body);
            const orderId = body.id || body.order_id;
            sleep(0.5);
            const fulfillRes = http.post(`${ORDERS_URL}/orders/${orderId}/fulfill`, null, params);
            check(fulfillRes, { 'order fulfilled': (r) => r.status === 200 });
          } catch (e) {
            // Fulfillment failed
          }
        }
      });

      sleep(0.1);
    }
  # High load full scenario test - complete user journey
  full-scenario-test-high-load.js: |
    import http from 'k6/http';
    import { check, group, sleep } from 'k6';
    import { Rate, Trend } from 'k6/metrics';

    // IN-CLUSTER FULL SCENARIO TEST
    // Complete user journey: Browse → Check Inventory → Order → Fulfill

    const errorRate = new Rate('errors');
    const orderCreationTime = new Trend('order_creation_duration');

    export const options = {
      scenarios: {
        full_journey: {
          executor: 'ramping-arrival-rate',
          startRate: 5,
          timeUnit: '1s',
          preAllocatedVUs: 15,
          maxVUs: 50,
          stages: [
            { duration: '1m', target: 10 },
            { duration: '1m', target: 30 },
            { duration: '2m', target: 50 },
            { duration: '3m', target: 100 },
            { duration: '3m', target: 150 },
            { duration: '1m', target: 50 },
            { duration: '1m', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<2000'],
        errors: ['rate<0.15'],
        order_creation_duration: ['p(95)<3000'],
      },
    };

    const PRODUCTS_URL = __ENV.PRODUCTS_URL || 'http://products-service:8001';
    const INVENTORY_URL = __ENV.INVENTORY_URL || 'http://inventory-service:8002';
    const ORDERS_URL = __ENV.ORDERS_URL || 'http://orders-service:8003';

    export default function () {
      group('Browse Products', function () {
        const res = http.get(`${PRODUCTS_URL}/products`);
        check(res, { 'products loaded': (r) => r.status === 200 });
      });

      group('Check Inventory', function () {
        const res = http.get(`${INVENTORY_URL}/inventory/1`);
        check(res, { 'inventory checked': (r) => r.status === 200 });
      });

      group('Create and Fulfill Order', function () {
        const orderPayload = JSON.stringify({
          customer_id: Math.floor(Math.random() * 1000) + 1,
          items: [
            { product_id: 1, quantity: 1 },
            { product_id: 3, quantity: 1 },
          ],
        });
        const params = { headers: { 'Content-Type': 'application/json' } };

        const start = new Date();
        const res = http.post(`${ORDERS_URL}/orders`, orderPayload, params);
        const duration = new Date() - start;
        orderCreationTime.add(duration);

        const orderCreated = check(res, {
          'order created': (r) => r.status === 200 || r.status === 201,
        });
        errorRate.add(!orderCreated);

        if (orderCreated) {
          try {
            const body = JSON.parse(res.body);
            const orderId = body.id || body.order_id;
            sleep(0.5);
            const fulfillRes = http.post(`${ORDERS_URL}/orders/${orderId}/fulfill`, null, params);
            check(fulfillRes, { 'order fulfilled': (r) => r.status === 200 });
          } catch (e) {
            // Fulfillment failed
          }
        }
      });

      sleep(0.1);
    }
