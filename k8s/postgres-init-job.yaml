apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-script
  namespace: inventory-system
data:
  init.sql: |
    -- Products table
    CREATE TABLE IF NOT EXISTS products (
        id SERIAL PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        price DECIMAL(10, 2) NOT NULL,
        category VARCHAR(100),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Inventory table
    CREATE TABLE IF NOT EXISTS inventory (
        product_id INTEGER PRIMARY KEY REFERENCES products(id) ON DELETE CASCADE,
        stock INTEGER NOT NULL DEFAULT 0,
        reserved INTEGER NOT NULL DEFAULT 0,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Orders table
    CREATE TABLE IF NOT EXISTS orders (
        id SERIAL PRIMARY KEY,
        customer_id INTEGER NOT NULL,
        status VARCHAR(50) NOT NULL DEFAULT 'pending',
        total_amount DECIMAL(10, 2) NOT NULL DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Order items table
    CREATE TABLE IF NOT EXISTS order_items (
        id SERIAL PRIMARY KEY,
        order_id INTEGER NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
        product_id INTEGER NOT NULL REFERENCES products(id),
        quantity INTEGER NOT NULL,
        price_at_order DECIMAL(10, 2) NOT NULL
    );

    -- Insert sample data
    INSERT INTO products (name, description, price, category) VALUES
        ('Laptop', 'High-performance laptop', 999.99, 'Electronics'),
        ('Mouse', 'Wireless optical mouse', 29.99, 'Electronics'),
        ('Keyboard', 'Mechanical keyboard', 79.99, 'Electronics'),
        ('Monitor', '24-inch LCD monitor', 199.99, 'Electronics'),
        ('Desk Chair', 'Ergonomic office chair', 149.99, 'Furniture')
    ON CONFLICT DO NOTHING;

    INSERT INTO inventory (product_id, stock, reserved) VALUES
        (1, 50, 0),
        (2, 100, 0),
        (3, 25, 0),
        (4, 30, 0),
        (5, 15, 0)
    ON CONFLICT DO NOTHING;
---
apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-init
  namespace: inventory-system
spec:
  template:
    spec:
      containers:
      - name: postgres-init
        image: postgres:16
        command:
        - /bin/bash
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do
            echo "Waiting..."
            sleep 2
          done
          echo "PostgreSQL is ready. Running init script..."
          PGPASSWORD=$DB_PASSWORD psql -h $DB_HOST -p $DB_PORT -U $DB_USER -d $DB_NAME -f /init/init.sql
          echo "Database initialized successfully!"
        env:
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: DB_HOST
        - name: DB_PORT
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: DB_PORT
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: DB_NAME
        - name: DB_USER
          valueFrom:
            configMapKeyRef:
              name: postgres-config
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-secret
              key: DB_PASSWORD
        volumeMounts:
        - name: init-script
          mountPath: /init
      volumes:
      - name: init-script
        configMap:
          name: postgres-init-script
      restartPolicy: OnFailure
  backoffLimit: 5
  